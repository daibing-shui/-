<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信号栅格智能分析平台 v2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Microsoft YaHei', 'Exo 2', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* 动态背景 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 50%, #0a0e1a 100%);
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 0, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(255, 255, 0, 0.05) 0%, transparent 50%);
            animation: bgRotate 30s linear infinite;
        }

        @keyframes bgRotate {
            from { transform: rotate(0deg) scale(1.5); }
            to { transform: rotate(360deg) scale(1.5); }
        }

        /* 网格背景效果 */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
            opacity: 0.3;
        }

        /* 主容器 - 适配1920x1080 */
        .main-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* 顶部标题栏 - 高度调整 */
        .header {
            background: linear-gradient(90deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 40, 80, 0.9) 50%, rgba(0, 20, 40, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(0, 255, 255, 0.5);
            padding: 10px 0;
            position: relative;
            overflow: hidden;
            height: 70px;
            z-index: 1000;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: scan 3s linear infinite;
        }

        @keyframes scan {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            height: 100%;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 40px rgba(0, 255, 255, 0.8); }
        }

        .title {
            font-family: 'Microsoft YaHei', 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        /* 时间和状态显示 */
        .status-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .time-display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.5);
            border-radius: 8px;
            padding: 8px 15px;
            font-family: 'Microsoft YaHei', 'Orbitron', sans-serif;
            font-size: 14px;
            color: #00ffff;
            position: relative;
            overflow: hidden;
        }

        /* 主要内容区域 - 适配高度 */
        .content {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
            position: relative;
            height: calc(100vh - 220px);
        }

        /* 左侧控制面板 - 宽度和高度调整 */
        .left-panel {
            width: 320px;
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 30, 60, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
            position: relative;
            max-height: 100%;
            z-index: 100;
        }

        .left-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, rgba(0, 255, 255, 0.1), transparent);
            border-radius: 15px 15px 0 0;
            pointer-events: none;
        }

        /* 面板标题 */
        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
            position: relative;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #00ffff, #0080ff);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 控制组 */
        .control-group {
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .control-group:hover {
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .control-group-title {
            font-size: 14px;
            font-weight: 600;
            color: #00ffff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 自定义选择器 */
        .custom-select {
            position: relative;
            margin-bottom: 8px;
        }

        .custom-select select {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px 30px 8px 10px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            transition: all 0.3s ease;
        }

        .custom-select select:hover {
            border-color: #00ffff;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
        }

        .custom-select select option {
            background: #1a2d4b;
            color: #c3e0ff;
        }

        /* 功能按钮 */
        .feature-btn {
            width: 100%;
            background: linear-gradient(135deg, rgba(0, 100, 200, 0.3) 0%, rgba(0, 150, 255, 0.3) 100%);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        .feature-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
            border-color: #00ffff;
        }

        .feature-btn.active {
            background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            color: #000;
            font-weight: 700;
        }

        /* 图层控制 */
        .layer-control {
            margin-bottom: 15px;
        }

        .layer-header {
            background: rgba(0, 50, 100, 0.3);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 255, 255, 0.2);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .layer-header:hover {
            background: rgba(0, 50, 100, 0.5);
            border-color: rgba(0, 255, 255, 0.4);
        }

        .layer-content {
            padding-left: 10px;
            max-height: 300px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .layer-content.collapsed {
            max-height: 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 13px;
        }

        .layer-item:hover {
            background: rgba(0, 50, 100, 0.4);
            border-color: rgba(0, 255, 255, 0.4);
            transform: translateX(3px);
        }

        /* 自定义复选框 - 修复版 */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            position: relative;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            border-color: #00ffff;
        }

        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid #000;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .layer-label {
            color: #fff;
            cursor: pointer;
            user-select: none;
        }

        /* 中央地图区域 */
        .map-container {
            flex: 1;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
            z-index: 50;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #0a0e1a;
        }

        /* 地图叠加层 */
        .map-overlay {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 20, 40, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            min-width: 240px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .overlay-title {
            font-size: 14px;
            font-weight: 600;
            color: #00ffff;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            font-size: 12px;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-value {
            color: #00ffff;
            font-weight: 600;
            font-family: 'Microsoft YaHei', 'Orbitron', sans-serif;
        }

        /* 右侧面板 */
        .right-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            max-height: 100%;
            z-index: 100;
        }

        /* 数据卡片 */
        .data-card {
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 30, 60, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .card-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #000;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 数字展示 */
        .number-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .number-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .number-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
            border-color: #00ffff;
        }

        .number-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .number-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'Microsoft YaHei', 'Orbitron', sans-serif;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        /* 图表容器 */
        .chart-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 10px;
            position: relative;
            z-index: 1;
            height: 150px;
        }

        .chart-container-large {
            height: 200px;
        }

        /* 底部数据面板 - 修复层级问题 */
        .bottom-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: linear-gradient(90deg, rgba(0, 20, 40, 0.95) 0%, rgba(0, 30, 60, 0.95) 50%, rgba(0, 20, 40, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.5);
            height: 140px;
            overflow: hidden;
            z-index: 1100;
        }

        .bottom-stat {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 15px;
        }

        .bottom-stat:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 30px;
            width: 1px;
            background: linear-gradient(to bottom, transparent, rgba(0, 255, 255, 0.5), transparent);
        }

        .bottom-stat-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'Microsoft YaHei', 'Orbitron', sans-serif;
            color: #00ffff;
            margin-bottom: 2px;
        }

        .bottom-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 自定义弹窗样式 - 优化版 */
        .custom-popup {
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.95) 0%, rgba(0, 30, 60, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid #00ffff;
            border-radius: 15px;
            color: #fff;
            font-family: 'Microsoft YaHei', sans-serif;
            min-width: 420px;
            max-width: 650px;
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.3), 0 0 20px rgba(0, 255, 255, 0.2);
            overflow: hidden;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            background: transparent;
            border-radius: 15px;
            padding: 0;
            margin: 0;
            box-shadow: none;
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
        }

        .custom-popup .leaflet-popup-tip-container {
            width: 30px;
            height: 30px;
            margin-top: -2px;
        }

        .custom-popup .leaflet-popup-tip {
            background: linear-gradient(135deg, rgba(0, 30, 60, 0.95) 0%, rgba(0, 30, 60, 0.95) 100%);
            border-bottom: 2px solid #00ffff;
            border-right: 2px solid #00ffff;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.3);
        }

        .popup-header {
            background: linear-gradient(135deg, rgba(0, 40, 80, 0.95) 0%, rgba(0, 60, 100, 0.95) 100%);
            color: #fff;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #00ffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .popup-close-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 50%;
        }

        .popup-close-btn:hover {
            background: #00ffff;
            color: #000;
            transform: rotate(90deg);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .popup-content {
            padding: 20px;
        }

        .popup-section {
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .popup-section:last-child {
            margin-bottom: 0;
        }

        .popup-section-title {
            font-size: 14px;
            color: #00ffff;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .popup-section-title i {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #00ffff, #0080ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #000;
        }

        .popup-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .popup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .popup-item:last-child {
            border-bottom: none;
        }

        .popup-label {
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 55%;
        }

        .popup-value {
            color: #00ffff;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 45%;
            text-align: right;
        }

        .popup-value.highlight {
            color: #ff00ff;
            font-size: 14px;
        }

        .popup-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin: -20px -20px 20px -20px;
        }

        .popup-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 20, 40, 0.5);
            border-bottom: 3px solid transparent;
        }

        .popup-tab.active {
            color: #fff;
            background: rgba(0, 60, 100, 0.7);
            border-bottom-color: #00ffff;
        }

        .popup-tab:hover:not(.active) {
            background: rgba(0, 40, 80, 0.5);
            color: #fff;
        }

        /* 图例 */
        .legend {
            background: rgba(0, 20, 40, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #fff;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #00ffff;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* 热力图图例 */
        .heatmap-legend {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .heatmap-gradient {
            width: 150px;
            height: 20px;
            background: linear-gradient(90deg, #0000FF 0%, #00FF00 25%, #FFFF00 50%, #FF8800 75%, #FF0000 100%);
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .heatmap-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #00ffff;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #00ffff, #0080ff);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #00ffff, #ff00ff);
        }

        /* 扫描线 */
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #00ffff, transparent);
            animation: scanLine 4s linear infinite;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes scanLine {
            from { transform: translateY(0); }
            to { transform: translateY(100vh); }
        }

        /* 深色主题的Leaflet控件 */
        .leaflet-control-zoom a {
            background: rgba(0, 20, 40, 0.9) !important;
            color: #00ffff !important;
            border: 1px solid rgba(0, 255, 255, 0.3) !important;
            font-size: 16px !important;
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            border-radius: 6px !important;
            margin-bottom: 3px !important;
            transition: all 0.3s ease !important;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(0, 50, 100, 0.9) !important;
            color: #fff !important;
            border-color: #00ffff !important;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5) !important;
        }

        .leaflet-control-attribution {
            background: rgba(0, 20, 40, 0.8) !important;
            color: rgba(255, 255, 255, 0.5) !important;
            border-radius: 6px 0 0 0 !important;
            padding: 3px 8px !important;
            font-size: 10px !important;
        }

        /* 数据更新动画 */
        .data-update {
            animation: dataFlash 0.5s ease;
        }

        @keyframes dataFlash {
            0% { background-color: transparent; }
            50% { background-color: rgba(0, 255, 255, 0.3); }
            100% { background-color: transparent; }
        }

        /* 子图层项 */
        .sub-layer-items {
            margin-left: 28px;
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sub-layer-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            background: rgba(20, 35, 60, 0.5);
            border-radius: 4px;
            border: 1px solid rgba(79, 172, 254, 0.15);
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .sub-layer-item:hover {
            background: rgba(30, 50, 80, 0.7);
            border-color: rgba(79, 172, 254, 0.3);
        }

        .sub-layer-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* 弹窗滚动条样式 */
        .popup-content::-webkit-scrollbar {
            width: 6px;
        }

        .popup-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .popup-content::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #00ffff, #0080ff);
            border-radius: 3px;
        }

        .popup-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #00ffff, #ff00ff);
        }

        .loading-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #00ffff;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(26, 45, 75, 0.6);
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .loading-indicator i {
            animation: spin 1s linear infinite;
        }

        /* 统计表格样式 */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .stats-table th {
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
        }

        .stats-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .stats-table tr:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        /* 场景统计图标 */
        .scene-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
            border-radius: 4px;
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        /* 统计详情表格 */
        .stats-detail-table {
            width: 100%;
            font-size: 11px;
            margin-top: 10px;
        }

        .stats-detail-table td {
            padding: 4px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .stats-detail-table .label {
            color: rgba(255, 255, 255, 0.7);
        }

        .stats-detail-table .value {
            color: #00ffff;
            font-weight: 600;
            text-align: right;
        }

        /* 特殊数据值样式 */
        .special-value {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .special-value.good {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid rgba(0, 255, 0, 0.4);
        }

        .special-value.warning {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
            border: 1px solid rgba(255, 255, 0, 0.4);
        }

        .special-value.danger {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
            border: 1px solid rgba(255, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <!-- 动态背景 -->
    <div class="bg-animation"></div>
    <div class="grid-bg"></div>
    
    <!-- 扫描线效果 -->
    <div class="scan-line"></div>
    
    <!-- 加载动画 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">系统初始化中...</div>
        </div>
    </div>
    
    <!-- 主容器 -->
    <div class="main-container">
        <!-- 顶部标题栏 -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div>
                        <h1 class="title">信号栅格智能分析平台 v2.0</h1>
                        <p class="subtitle">OTT_MR Network Coverage Analysis System</p>
                    </div>
                </div>
                <div class="status-section">
                    <div class="time-display">
                        <i class="far fa-clock"></i> <span id="time-text">2025-07-10 14:30:00</span>
                    </div>
                    <div class="time-display">
                        <i class="fas fa-database"></i> <span id="data-status">实时数据</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 主要内容区域 -->
        <div class="content">
            <!-- 左侧控制面板 -->
            <div class="left-panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <h2 class="panel-title">智能控制中心</h2>
                </div>
                
                <!-- 时间控制 -->
                <div class="control-group">
                    <div class="control-group-title">
                        <i class="fas fa-calendar-alt"></i>
                        <span>时间维度选择</span>
                    </div>
                    <div class="custom-select">
                        <select id="year-selector">
                            <option value="2025">2025年</option>
                            <option value="2024">2024年</option>
                            <option value="2023">2023年</option>
                        </select>
                    </div>
                    <div class="custom-select">
                        <select id="month-selector">
                            <option value="01">1月</option>
                            <option value="02">2月</option>
                            <option value="03">3月</option>
                            <option value="04">4月</option>
                            <option value="05">5月</option>
                            <option value="06">6月</option>
                            <option value="07" selected>7月</option>
                            <option value="08">8月</option>
                            <option value="09">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="loading-indicator" id="time-loading">
                        <i class="fas fa-spinner"></i>
                        <span>加载数据中...</span>
                    </div>
                </div>
                
                <!-- 功能模块 -->
                <div class="control-group">
                    <div class="control-group-title">
                        <i class="fas fa-cube"></i>
                        <span>功能模块</span>
                    </div>
                    <button class="feature-btn" data-layer="step-measurement">
                        <i class="fas fa-walking"></i>
                        <span>步测数据分析</span>
                    </button>
                    <button class="feature-btn" data-layer="point-measurement">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>点测数据分析</span>
                    </button>
                    <button class="feature-btn" data-layer="3d-simulation">
                        <i class="fas fa-cube"></i>
                        <span>3D建模仿真</span>
                    </button>
                    <button class="feature-btn" data-layer="indoor-property">
                        <i class="fas fa-building"></i>
                        <span>室分产权分析</span>
                    </button>
                </div>
                
                <!-- 图层控制 -->
                <div class="layer-control">
                    <div class="layer-header" onclick="toggleLayer(this)">
                        <span class="layer-title">基础图层控制</span>
                        <i class="fas fa-chevron-down layer-toggle"></i>
                    </div>
                    <div class="layer-content">
                        <div class="layer-item">
                            <input type="checkbox" id="aoi-border" checked>
                            <label class="layer-label" for="aoi-border">AOI边框显示</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="discrete-points" checked>
                            <label class="layer-label" for="discrete-points">离散点分布</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="buildings-layer">
                            <label class="layer-label" for="buildings-layer">建筑物图层</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="grids-layer">
                            <label class="layer-label" for="grids-layer">栅格图层</label>
                        </div>
                    </div>
                </div>
                
                <div class="layer-control">
                    <div class="layer-header" onclick="toggleLayer(this)">
                        <span class="layer-title">场景划分</span>
                        <i class="fas fa-chevron-down layer-toggle"></i>
                    </div>
                    <div class="layer-content">
                        <div class="layer-item">
                            <input type="checkbox" id="scene-education">
                            <label class="layer-label" for="scene-education">高等学校</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-transport">
                            <label class="layer-label" for="scene-transport">交通枢纽</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-business">
                            <label class="layer-label" for="scene-business">商务楼宇</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-tourism">
                            <label class="layer-label" for="scene-tourism">文旅场景</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-medical">
                            <label class="layer-label" for="scene-medical">医疗机构</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-government">
                            <label class="layer-label" for="scene-government">政务中心</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-shopping">
                            <label class="layer-label" for="scene-shopping">重点商超</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="scene-residential">
                            <label class="layer-label" for="scene-residential">住宅小区</label>
                        </div>
                    </div>
                </div>
                
                <div class="layer-control">
                    <div class="layer-header" onclick="toggleLayer(this)">
                        <span class="layer-title">运营商网络</span>
                        <i class="fas fa-chevron-down layer-toggle"></i>
                    </div>
                    <div class="layer-content">
                        <!-- 移动 -->
                        <div class="layer-item">
                            <input type="checkbox" id="operator-mobile">
                            <label class="layer-label" for="operator-mobile">中国移动</label>
                        </div>
                        <div class="sub-layer-items" id="mobile-sub-layers" style="display: none;">
                            <div class="sub-layer-item">
                                <input type="checkbox" id="mobile-4g">
                                <label class="layer-label" for="mobile-4g">4G网络</label>
                            </div>
                            <div class="sub-layer-item">
                                <input type="checkbox" id="mobile-5g">
                                <label class="layer-label" for="mobile-5g">5G网络</label>
                            </div>
                        </div>

                        <!-- 联通 -->
                        <div class="layer-item">
                            <input type="checkbox" id="operator-unicom">
                            <label class="layer-label" for="operator-unicom">中国联通</label>
                        </div>
                        <div class="sub-layer-items" id="unicom-sub-layers" style="display: none;">
                            <div class="sub-layer-item">
                                <input type="checkbox" id="unicom-4g">
                                <label class="layer-label" for="unicom-4g">4G网络</label>
                            </div>
                            <div class="sub-layer-item">
                                <input type="checkbox" id="unicom-5g">
                                <label class="layer-label" for="unicom-5g">5G网络</label>
                            </div>
                        </div>

                        <!-- 电信 -->
                        <div class="layer-item">
                            <input type="checkbox" id="operator-telecom">
                            <label class="layer-label" for="operator-telecom">中国电信</label>
                        </div>
                        <div class="sub-layer-items" id="telecom-sub-layers" style="display: none;">
                            <div class="sub-layer-item">
                                <input type="checkbox" id="telecom-4g">
                                <label class="layer-label" for="telecom-4g">4G网络</label>
                            </div>
                            <div class="sub-layer-item">
                                <input type="checkbox" id="telecom-5g">
                                <label class="layer-label" for="telecom-5g">5G网络</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="layer-control">
                    <div class="layer-header" onclick="toggleLayer(this)">
                        <span class="layer-title">热力图层</span>
                        <i class="fas fa-chevron-down layer-toggle"></i>
                    </div>
                    <div class="layer-content">
                        <div class="layer-item">
                            <input type="checkbox" id="heatmap-download">
                            <label class="layer-label" for="heatmap-download">下载速率热力图</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="heatmap-upload">
                            <label class="layer-label" for="heatmap-upload">上传速率热力图</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 中央地图区域 -->
            <div class="map-container">
                <div id="map"></div>
                
                <!-- 地图叠加层 -->
                <div class="map-overlay">
                    <h3 class="overlay-title">实时监控数据</h3>
                    <div class="stat-item">
                        <span class="stat-label">当前区域</span>
                        <span class="stat-value">济源市</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">数据点总数</span>
                        <span class="stat-value" id="total-points-overlay">加载中...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">平均信号强度</span>
                        <span class="stat-value" id="avg-rsrp-overlay">加载中...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">当前时间</span>
                        <span class="stat-value" id="current-time-display">2025年7月</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">网络覆盖率</span>
                        <span class="stat-value" id="coverage-rate-overlay">加载中...</span>
                    </div>
                </div>
            </div>
            
            <!-- 右侧面板 -->
            <div class="right-panel">
                <!-- 网络质量卡片 -->
                <div class="data-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-signal"></i>
                        </div>
                        <h3 class="card-title">网络质量分析</h3>
                    </div>
                    <div class="number-display">
                        <div class="number-item">
                            <div class="number-label">优良覆盖</div>
                            <div class="number-value" id="good-coverage">-</div>
                        </div>
                        <div class="number-item">
                            <div class="number-label">弱覆盖区域</div>
                            <div class="number-value" id="weak-coverage">-</div>
                        </div>
                        <div class="number-item">
                            <div class="number-label">5G覆盖率</div>
                            <div class="number-value" id="5g-coverage">-</div>
                        </div>
                        <div class="number-item">
                            <div class="number-label">数据更新</div>
                            <div class="number-value" id="last-update">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- 运营商份额图表 -->
                <div class="data-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3 class="card-title">市场份额分析</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="market-share-chart"></canvas>
                    </div>
                </div>
                
                <!-- 终端品牌分析 -->
                <div class="data-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <h3 class="card-title">终端品牌分布</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="brand-chart"></canvas>
                    </div>
                </div>

                <!-- 场景覆盖分析 -->
                <div class="data-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-city"></i>
                        </div>
                        <h3 class="card-title">场景覆盖分析</h3>
                    </div>
                    <div class="chart-container chart-container-large">
                        <canvas id="scene-coverage-chart"></canvas>
                    </div>
                </div>

                <!-- 详细统计信息 -->
                <div class="data-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3 class="card-title">详细统计信息</h3>
                    </div>
                    <table class="stats-detail-table">
                        <tr>
                            <td class="label">总数据行数</td>
                            <td class="value" id="stat-total-rows">-</td>
                        </tr>
                        <tr>
                            <td class="label">有效数据行数</td>
                            <td class="value" id="stat-valid-rows">-</td>
                        </tr>
                        <tr>
                            <td class="label">建筑物数量</td>
                            <td class="value" id="stat-building-count">-</td>
                        </tr>
                        <tr>
                            <td class="label">AOI数量</td>
                            <td class="value" id="stat-aoi-count">-</td>
                        </tr>
                        <tr>
                            <td class="label">栅格数量</td>
                            <td class="value" id="stat-grid-count">-</td>
                        </tr>
                        <tr>
                            <td class="label">离散点数量</td>
                            <td class="value" id="stat-discrete-count">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 底部数据面板 -->
        <div class="bottom-panel">
            <div class="bottom-stat">
                <div class="bottom-stat-value" id="scene-count">-</div>
                <div class="bottom-stat-label">场景数量</div>
            </div>
            <div class="bottom-stat">
                <div class="bottom-stat-value" id="building-count">-</div>
                <div class="bottom-stat-label">建筑物总数</div>
            </div>
            <div class="bottom-stat">
                <div class="bottom-stat-value" id="grid-count">-</div>
                <div class="bottom-stat-label">栅格总数</div>
            </div>
            <div class="bottom-stat">
                <div class="bottom-stat-value" id="discrete-count">-</div>
                <div class="bottom-stat-label">离散点数</div>
            </div>
            
            <!-- 新增统计信息区域 -->
            <div class="bottom-stat" style="flex: 2;">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>运营商</th>
                            <th>4G点数</th>
                            <th>5G点数</th>
                            <th>平均RSRP</th>
                        </tr>
                    </thead>
                    <tbody id="operator-stats-tbody">
                        <tr>
                            <td>中国移动</td>
                            <td id="mobile-4g-count">-</td>
                            <td id="mobile-5g-count">-</td>
                            <td id="mobile-avg-rsrp">-</td>
                        </tr>
                        <tr>
                            <td>中国联通</td>
                            <td id="unicom-4g-count">-</td>
                            <td id="unicom-5g-count">-</td>
                            <td id="unicom-avg-rsrp">-</td>
                        </tr>
                        <tr>
                            <td>中国电信</td>
                            <td id="telecom-4g-count">-</td>
                            <td id="telecom-5g-count">-</td>
                            <td id="telecom-avg-rsrp">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量
        var map;
        var currentNetworkType = '4g';
        var currentOperator = null;
        var statisticsData = null;
        var currentYear = '2025';
        var currentMonth = '07';
        var chartInstances = {};
        var currentLegend = null;

        // 图层组 - 包含所有图层类型
        var layerGroups = {
            aoiBorder: L.layerGroup(),
            discretePoints: L.layerGroup(),
            grids: {
                mobile: { '4g': L.layerGroup(), '5g': L.layerGroup() },
                unicom: { '4g': L.layerGroup(), '5g': L.layerGroup() },
                telecom: { '4g': L.layerGroup(), '5g': L.layerGroup() }
            },
            buildings: {
                mobile: { '4g': L.layerGroup(), '5g': L.layerGroup() },
                unicom: { '4g': L.layerGroup(), '5g': L.layerGroup() },
                telecom: { '4g': L.layerGroup(), '5g': L.layerGroup() }
            },
            scenes: {
                education: L.layerGroup(),
                transport: L.layerGroup(),
                business: L.layerGroup(),
                tourism: L.layerGroup(),
                medical: L.layerGroup(),
                government: L.layerGroup(),
                shopping: L.layerGroup(),
                residential: L.layerGroup()
            },
            testData: {
                stepMeasurement: L.layerGroup(),
                pointMeasurement: L.layerGroup(),
                simulation3d: L.layerGroup(),
                indoorProperty: L.layerGroup()
            },
            heatmaps: {
                download: null,
                upload: null
            },
            // 新增基础建筑物和栅格图层
            baseBuildings: L.layerGroup(),
            baseGrids: L.layerGroup()
        };

        // 场景类型映射
        const SCENE_MAPPING = {
            '高等学校': 'education',
            '交通枢纽': 'transport',
            '商务楼宇及酒店': 'business',
            '文旅场景': 'tourism',
            '医疗机构': 'medical',
            '政务中心': 'government',
            '重点商超': 'shopping',
            '住宅小区': 'residential'
        };

        // 初始化时间显示
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('time-text').textContent = timeStr;
        }

        // 每秒更新时间
        setInterval(updateTime, 1000);
        updateTime();

        // 显示加载动画
        function showLoading(text = '系统初始化中...') {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('active');
            overlay.querySelector('.loading-text').textContent = text;
        }

        // 隐藏加载动画
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('active');
        }

        // 图层切换
        function toggleLayer(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('collapsed');
            const icon = element.querySelector('.layer-toggle');
            if (element.classList.contains('collapsed')) {
                icon.style.transform = 'rotate(-90deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // 获取当前时间路径
        function getCurrentTimePath() {
            return `${currentYear}${currentMonth}/`;
        }

        // 获取当前选中的运营商和网络
        function getActiveOperatorNetworks() {
            const active = [];
            const operators = ['mobile', 'unicom', 'telecom'];
            const networks = ['4g', '5g'];
            
            operators.forEach(operator => {
                networks.forEach(network => {
                    const checkbox = document.getElementById(`${operator}-${network}`);
                    if (checkbox && checkbox.checked) {
                        active.push({ operator, network });
                    }
                });
            });
            
            return active;
        }

        // 获取当前选中的场景
        function getActiveScenes() {
            const sceneMapping = {
                'scene-education': 'education',
                'scene-transport': 'transport',
                'scene-business': 'business',
                'scene-tourism': 'tourism',
                'scene-medical': 'medical',
                'scene-government': 'government',
                'scene-shopping': 'shopping',
                'scene-residential': 'residential'
            };
            
            const active = [];
            Object.entries(sceneMapping).forEach(([checkboxId, sceneType]) => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox && checkbox.checked) {
                    active.push(sceneType);
                }
            });
            
            return active;
        }

        // 初始化地图
        function initMap() {
            showLoading('初始化地图...');
            
            map = L.map('map', {
                center: [35.08, 112.59],
                zoom: 13,
                zoomControl: true,
                attributionControl: true
            });

            // 添加高德卫星图层
            var satelliteMap = L.tileLayer('https://server.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png', {
                attribution: '高德卫星地图',
                maxZoom: 18,
                subdomains: ['0','1','2','3','4','5','6','7']
            }).addTo(map);

            // 添加高德标注图层
            var annotionMap = L.tileLayer('http://online{s}.map.bdimg.com/tile/?qt=tile&x={x}&y={y}&z={z}&styles=sl', {
                attribution: '高德标注地图',
                maxZoom: 18,
                subdomains: ['0','1','2','3','4','5','6','7']
            }).addTo(map);

            // 添加默认图层
            layerGroups.aoiBorder.addTo(map);
            layerGroups.discretePoints.addTo(map);
            
            hideLoading();
        }

        // 创建SVG离散点图标函数
        function createDiscreteIcon() {
            const svgString = `
                <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(255, 107, 53, 0.4)"/>
                        </filter>
                    </defs>
                    <circle cx="16" cy="16" r="15" fill="rgba(255, 107, 53, 0.15)" 
                            stroke="#FF6B35" stroke-width="3" filter="url(#shadow)"/>
                    <circle cx="16" cy="16" r="12" fill="none" stroke="rgba(255, 107, 53, 0.6)" stroke-width="1"/>
                    <rect x="8" y="11" width="16" height="10" fill="rgba(0, 0, 0, 0.8)" rx="2"/>
                    <text x="16" y="18" text-anchor="middle" font-family="Microsoft YaHei, Arial" 
                          font-size="11" font-weight="bold" fill="#FFFFFF" 
                          stroke="#FF6B35" stroke-width="0.5">室分</text>
                </svg>
            `;
            
            const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
            
            return L.icon({
                iconUrl: svgDataUrl,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16],
                className: 'svg-discrete-icon'
            });
        }

        // 加载GeoJSON数据
        function loadGeoJson(filename, style, onEachFeature, layerGroup, pointToLayer) {
            const url = getCurrentTimePath() + filename;
            showLoading(`加载数据: ${filename}...`);
            
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    layerGroup.clearLayers();
                    
                    L.geoJSON(data, {
                        style: style,
                        onEachFeature: onEachFeature,
                        pointToLayer: pointToLayer || function(feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 8,
                                fillColor: '#00ffff',
                                color: 'white',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        }
                    }).addTo(layerGroup);
                    
                    hideLoading();
                    return true;
                })
                .catch(error => {
                    console.log(`未找到文件: ${url}`);
                    layerGroup.clearLayers();
                    hideLoading();
                    return false;
                });
        }

        // 加载统计数据
        function loadStatistics() {
            const url = getCurrentTimePath() + 'statistics.json';
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    statisticsData = data;
                    updateStatisticsDisplay();
                    return true;
                })
                .catch(error => {
                    console.log('统计数据加载失败:', error);
                    statisticsData = null;
                    updateStatisticsDisplay();
                    return false;
                });
        }

        // 更新统计显示
        function updateStatisticsDisplay() {
            if (statisticsData) {
                // 更新数据点总数
                document.getElementById('total-points-overlay').textContent = 
                    statisticsData.data.total_rows.toLocaleString();
                
                // 更新详细统计信息
                document.getElementById('stat-total-rows').textContent = 
                    statisticsData.data.total_rows.toLocaleString();
                document.getElementById('stat-valid-rows').textContent = 
                    statisticsData.data.valid_rows.toLocaleString();
                document.getElementById('stat-building-count').textContent = 
                    statisticsData.data.building_count.toLocaleString();
                document.getElementById('stat-aoi-count').textContent = 
                    statisticsData.data.aoi_count.toLocaleString();
                document.getElementById('stat-grid-count').textContent = 
                    statisticsData.data.grid_count || '45.2K';
                document.getElementById('stat-discrete-count').textContent = 
                    statisticsData.data.discrete_points.toLocaleString();
                
                // 更新场景和建筑物数量
                document.getElementById('scene-count').textContent = 
                    Object.values(statisticsData.scenes).reduce((sum, scene) => sum + (scene.count > 0 ? 1 : 0), 0);
                document.getElementById('building-count').textContent = 
                    statisticsData.data.building_count.toLocaleString();
                document.getElementById('discrete-count').textContent = 
                    statisticsData.data.discrete_points.toLocaleString();
                document.getElementById('grid-count').textContent = 
                    statisticsData.data.grid_count || '45.2K';
                
                // 计算弱覆盖占比
                let totalWeak = 0;
                let totalPoints = 0;
                let total5gPoints = 0;
                Object.values(statisticsData.operators).forEach(operator => {
                    Object.entries(operator).forEach(([network, data]) => {
                        totalWeak += data.weak;
                        totalPoints += data.total;
                        if (network === '5g') {
                            total5gPoints += data.total;
                        }
                    });
                });
                
                const weakPercent = totalPoints > 0 ? (totalWeak / totalPoints * 100).toFixed(1) : 0;
                const goodPercent = totalPoints > 0 ? (100 - weakPercent).toFixed(1) : 0;
                const coverage5g = totalPoints > 0 ? (total5gPoints / totalPoints * 100).toFixed(1) : 0;
                
                document.getElementById('weak-coverage').textContent = `${weakPercent}%`;
                document.getElementById('good-coverage').textContent = `${goodPercent}%`;
                document.getElementById('5g-coverage').textContent = `${coverage5g}%`;
                document.getElementById('coverage-rate-overlay').textContent = `${goodPercent}%`;
                
                // 计算平均RSRP
                let totalRsrp = 0;
                let rsrpCount = 0;
                Object.values(statisticsData.operators).forEach(operator => {
                    Object.values(operator).forEach(data => {
                        if (data.total > 0) {
                            totalRsrp += data.rsrp_sum;
                            rsrpCount += data.total;
                        }
                    });
                });
                const avgRsrp = rsrpCount > 0 ? (totalRsrp / rsrpCount).toFixed(1) : 0;
                document.getElementById('avg-rsrp-overlay').textContent = `${avgRsrp} dBm`;
                
                // 更新时间显示
                document.getElementById('last-update').textContent = 
                    `${currentYear}.${parseInt(currentMonth)}`;
                
                // 更新运营商统计表格
                updateOperatorStatsTable();
                
                // 初始化图表
                initCharts();
            } else {
                // 显示默认值
                document.getElementById('total-points-overlay').textContent = '暂无数据';
                document.getElementById('scene-count').textContent = '-';
                document.getElementById('building-count').textContent = '-';
                document.getElementById('discrete-count').textContent = '-';
                document.getElementById('grid-count').textContent = '-';
                document.getElementById('weak-coverage').textContent = '-';
                document.getElementById('good-coverage').textContent = '-';
                document.getElementById('5g-coverage').textContent = '-';
                document.getElementById('avg-rsrp-overlay').textContent = '-';
                document.getElementById('last-update').textContent = '-';
                document.getElementById('coverage-rate-overlay').textContent = '-';
            }
        }

        // 更新运营商统计表格
        function updateOperatorStatsTable() {
            if (!statisticsData) return;

            const operators = ['mobile', 'unicom', 'telecom'];
            operators.forEach(operator => {
                const stats = statisticsData.operators[operator];
                const count4g = stats['4g'].total;
                const count5g = stats['5g'].total;
                const totalRsrp = stats['4g'].rsrp_sum + stats['5g'].rsrp_sum;
                const totalCount = count4g + count5g;
                const avgRsrp = totalCount > 0 ? (totalRsrp / totalCount).toFixed(1) : '-';

                document.getElementById(`${operator}-4g-count`).textContent = count4g.toLocaleString();
                document.getElementById(`${operator}-5g-count`).textContent = count5g.toLocaleString();
                document.getElementById(`${operator}-avg-rsrp`).textContent = avgRsrp === '-' ? '-' : `${avgRsrp} dBm`;
            });
        }

        // 更新当前时间显示
        function updateCurrentTimeDisplay() {
            const yearText = currentYear + '年';
            const monthText = parseInt(currentMonth) + '月';
            document.getElementById('current-time-display').textContent = `${yearText}${monthText}`;
        }

        // 清空所有图层
        function clearAllLayers() {
            layerGroups.aoiBorder.clearLayers();
            layerGroups.discretePoints.clearLayers();
            layerGroups.baseBuildings.clearLayers();
            
            Object.values(layerGroups.grids).forEach(operator => {
                Object.values(operator).forEach(network => {
                    network.clearLayers();
                });
            });

            Object.values(layerGroups.buildings).forEach(operator => {
                Object.values(operator).forEach(network => {
                    network.clearLayers();
                });
            });
            
            Object.values(layerGroups.scenes).forEach(scene => {
                scene.clearLayers();
            });
            
            Object.values(layerGroups.testData).forEach(testData => {
                testData.clearLayers();
            });
            
            // 清理热力图
            if (layerGroups.heatmaps.download) {
                map.removeLayer(layerGroups.heatmaps.download);
                layerGroups.heatmaps.download = null;
            }
            if (layerGroups.heatmaps.upload) {
                map.removeLayer(layerGroups.heatmaps.upload);
                layerGroups.heatmaps.upload = null;
            }
        }

        // 时间切换处理函数
        function handleTimeChange() {
            const loadingIndicator = document.getElementById('time-loading');
            
            loadingIndicator.style.display = 'flex';
            updateCurrentTimeDisplay();
            clearAllLayers();
            
            Promise.all([
                loadStatistics(),
                loadBaseData()
            ]).then(() => {
                // 重新加载当前激活的图层
                updateAllLayers();
                
                loadingIndicator.style.display = 'none';
                console.log(`已切换到 ${currentYear}年${parseInt(currentMonth)}月`);
            }).catch(error => {
                console.error('加载数据时出错:', error);
                loadingIndicator.style.display = 'none';
            });
        }

        // 更新所有图层
        function updateAllLayers() {
            // 更新AOI边框
            updateAoiLayer();
            // 更新建筑物图层
            updateBuildingsLayer();
            // 更新栅格图层
            updateGridsLayer();
            // 更新功能模块图层
            updateTestDataLayers();
            // 更新热力图层
            updateHeatmapLayers();
        }

        // 更新AOI图层
        function updateAoiLayer() {
            const aoiChecked = document.getElementById('aoi-border').checked;
            const activeScenes = getActiveScenes();
            
            if (aoiChecked) {
                if (activeScenes.length === 0) {
                    // 仅勾选AOI，加载基础AOI文件
                    loadGeoJson('aoi.geojson', {
                        color: '#4facfe',
                        weight: 2,
                        fillOpacity: 0.1,
                        fillColor: '#4facfe'
                    }, null, layerGroups.aoiBorder).then(success => {
                        if (success) {
                            layerGroups.aoiBorder.addTo(map);
                        }
                    });
                } else {
                    // 加载所有选中场景的AOI文件
                    layerGroups.aoiBorder.clearLayers();
                    activeScenes.forEach(scene => {
                        loadSceneData(scene);
                    });
                    layerGroups.aoiBorder.addTo(map);
                }
            } else {
                map.removeLayer(layerGroups.aoiBorder);
            }
        }

        // 更新建筑物图层
        function updateBuildingsLayer() {
            const buildingsChecked = document.getElementById('buildings-layer').checked;
            const activeOperatorNetworks = getActiveOperatorNetworks();
            
            // 先移除所有建筑物图层
            map.removeLayer(layerGroups.baseBuildings);
            Object.values(layerGroups.buildings).forEach(operator => {
                Object.values(operator).forEach(network => {
                    map.removeLayer(network);
                });
            });
            
            if (buildingsChecked) {
                if (activeOperatorNetworks.length === 0) {
                    // 仅勾选建筑物，加载基础建筑物文件
                    loadGeoJson('buildings.geojson', function(feature) {
                        return {
                            fillColor: feature.properties.color || '#4facfe',
                            weight: 2,
                            opacity: 1,
                            color: '#333',
                            fillOpacity: 0.7
                        };
                    }, function(feature, layer) {
                        const popupContent = createBuildingPopup(feature.properties);
                        layer.bindPopup(popupContent, {
                            className: 'custom-popup',
                            maxWidth: 600,
                            minWidth: 400
                        });
                    }, layerGroups.baseBuildings).then(success => {
                        if (success) {
                            layerGroups.baseBuildings.addTo(map);
                        }
                    });
                } else {
                    // 加载对应运营商和网络的建筑物文件
                    activeOperatorNetworks.forEach(({ operator, network }) => {
                        loadBuildingData(operator, network).then(success => {
                            if (success) {
                                layerGroups.buildings[operator][network].addTo(map);
                            }
                        });
                    });
                }
            }
        }

        // 更新栅格图层
        function updateGridsLayer() {
            const gridsChecked = document.getElementById('grids-layer').checked;
            const activeOperatorNetworks = getActiveOperatorNetworks();
            const activeScenes = getActiveScenes();
            
            // 先移除所有栅格图层
            Object.values(layerGroups.grids).forEach(operator => {
                Object.values(operator).forEach(network => {
                    map.removeLayer(network);
                });
            });
            
            if (gridsChecked && activeOperatorNetworks.length > 0) {
                activeOperatorNetworks.forEach(({ operator, network }) => {
                    if (activeScenes.length === 0) {
                        // 无场景选择，加载基础栅格文件
                        loadOperatorNetworkData(operator, network).then(success => {
                            if (success) {
                                layerGroups.grids[operator][network].addTo(map);
                                updateLegend(network);
                            }
                        });
                    } else {
                        // 有场景选择，加载场景特定的栅格文件
                        activeScenes.forEach(scene => {
                            const filename = `grid_${scene}_${operator}_${network}.geojson`;
                            loadGeoJson(filename, function(feature) {
                                return {
                                    fillColor: feature.properties.color,
                                    weight: 1,
                                    opacity: 1,
                                    color: 'rgba(255, 255, 255, 0.3)',
                                    fillOpacity: 0.7
                                };
                            }, function(feature, layer) {
                                const popupContent = createGridPopup(feature.properties, operator, network);
                                layer.bindPopup(popupContent, {
                                    className: 'custom-popup'
                                });
                            }, layerGroups.grids[operator][network]).then(success => {
                                if (success) {
                                    layerGroups.grids[operator][network].addTo(map);
                                    updateLegend(network);
                                }
                            });
                        });
                    }
                });
            }
        }

        // 更新功能模块图层
        function updateTestDataLayers() {
            document.querySelectorAll('.feature-btn.active').forEach(button => {
                const layerType = button.dataset.layer;
                loadTestData(layerType).then(success => {
                    if (success) {
                        const layerKey = layerType.replace('-', '');
                        if (layerGroups.testData[layerKey]) {
                            layerGroups.testData[layerKey].addTo(map);
                        }
                    }
                });
            });
        }

        // 更新热力图层
        function updateHeatmapLayers() {
            const downloadChecked = document.getElementById('heatmap-download').checked;
            const uploadChecked = document.getElementById('heatmap-upload').checked;
            const activeScenes = getActiveScenes();

            // 移除现有热力图
            if (layerGroups.heatmaps.download) {
                map.removeLayer(layerGroups.heatmaps.download);
                layerGroups.heatmaps.download = null;
            }
            if (layerGroups.heatmaps.upload) {
                map.removeLayer(layerGroups.heatmaps.upload);
                layerGroups.heatmaps.upload = null;
            }

            if (downloadChecked) {
                if (activeScenes.length === 0) {
                    // 加载总体下载热力图
                    loadHeatmapData('download').then(success => {
                        if (success) {
                            layerGroups.heatmaps.download.addTo(map);
                        }
                    });
                } else {
                    // 加载场景特定的下载热力图
                    activeScenes.forEach(scene => {
                        loadHeatmapData(`download_${scene}`).then(success => {
                            if (success && layerGroups.heatmaps.download) {
                                layerGroups.heatmaps.download.addTo(map);
                            }
                        });
                    });
                }
            }

            if (uploadChecked) {
                if (activeScenes.length === 0) {
                    // 加载总体上传热力图
                    loadHeatmapData('upload').then(success => {
                        if (success) {
                            layerGroups.heatmaps.upload.addTo(map);
                        }
                    });
                } else {
                    // 加载场景特定的上传热力图
                    activeScenes.forEach(scene => {
                        loadHeatmapData(`upload_${scene}`).then(success => {
                            if (success && layerGroups.heatmaps.upload) {
                                layerGroups.heatmaps.upload.addTo(map);
                            }
                        });
                    });
                }
            }
            
            // 更新图例
            updateLegend(currentNetworkType);
        }

        // 加载基础数据
        function loadBaseData() {
            const promises = [];
            
            // 加载离散点
            promises.push(loadGeoJson('discrete_points.geojson', {}, function(feature, layer) {
                const props = feature.properties;
                const popupContent = createDiscretePointPopup(props);
                layer.bindPopup(popupContent, {
                    className: 'custom-popup',
                    maxWidth: 650,
                    minWidth: 420,
                    autoPan: true
                });
            }, layerGroups.discretePoints, function(feature, latlng) {
                return L.marker(latlng, {
                    icon: createDiscreteIcon()
                });
            }));

            // 加载AOI边框
            promises.push(loadGeoJson('aoi.geojson', {
                color: '#4facfe',
                weight: 2,
                fillOpacity: 0.1,
                fillColor: '#4facfe'
            }, null, layerGroups.aoiBorder));
            
            return Promise.all(promises);
        }

        // 创建离散点弹窗内容 - 完整显示所有信息
        function createDiscretePointPopup(props) {
            const popupDiv = document.createElement('div');
            
            // 创建弹窗头部
            const header = document.createElement('div');
            header.className = 'popup-header';
            header.innerHTML = `
                <span>${props['场所名称'] || props['现站点'] || '离散点信息'}</span>
                <button class="popup-close-btn" onclick="map.closePopup()">×</button>
            `;
            
            // 创建弹窗内容
            const content = document.createElement('div');
            content.className = 'popup-content';
            
            // 创建标签页
            const tabs = document.createElement('div');
            tabs.className = 'popup-tabs';
            tabs.innerHTML = `
                <div class="popup-tab active" onclick="switchTab(this, 'basic')">基本信息</div>
                <div class="popup-tab" onclick="switchTab(this, 'coverage')">覆盖情况</div>
                <div class="popup-tab" onclick="switchTab(this, 'business')">业主信息</div>
                <div class="popup-tab" onclick="switchTab(this, 'network')">网络质量</div>
            `;
            
            // 基本信息内容
            const basicContent = document.createElement('div');
            basicContent.id = 'basic-content';
            basicContent.innerHTML = `
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-info-circle"></i>
                        基本信息
                    </div>
                    ${createPopupItems({
                        '唯一编码': props['唯一编码'],
                        '省份': props['省份'],
                        '地市': props['地市'],
                        '区县': props['区县'],
                        '地址': props['地址'],
                        '场景类型': props['场景类型1'],
                        '场景细分': props['场景细分'],
                        '现站点': props['现站点'],
                        '所属AOI': props['所属AOI']
                    })}
                </div>
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-building"></i>
                        站点信息
                    </div>
                    ${createPopupItems({
                        '楼栋数': props['站点信息-楼栋数(栋)'] ? `${props['站点信息-楼栋数(栋)']}栋` : '暂无',
                        '建筑面积': props['站点信息-建筑面积(㎡)'] ? `${props['站点信息-建筑面积(㎡)']}㎡` : '暂无',
                        '地下停车场数量': props['站点信息-地下停车场数量(处)'] || '暂无',
                        '地下停车场面积': props['站点信息-地下停车场面积(㎡)'] ? `${props['站点信息-地下停车场面积(㎡)']}㎡` : '暂无',
                        '电梯数量': props['站点信息-电梯数量(部)'] || '暂无'
                    })}
                </div>
            `;
            
            // 覆盖情况内容
            const coverageContent = document.createElement('div');
            coverageContent.id = 'coverage-content';
            coverageContent.style.display = 'none';
            coverageContent.innerHTML = `
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-wifi"></i>
                        平层覆盖
                    </div>
                    ${createPopupItems({
                        '移动': formatCoverageStatus(props['平层-移动(平层)']),
                        '电信': formatCoverageStatus(props['平层-电信(平层)']),
                        '联通': formatCoverageStatus(props['平层-联通(平层)'])
                    })}
                </div>
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-sort-amount-up"></i>
                        电梯覆盖
                    </div>
                    ${createPopupItems({
                        '有无电梯': props['电梯-有无电梯(电梯)'] || '暂无',
                        '移动': formatCoverageStatus(props['电梯-移动(电梯)']),
                        '电信': formatCoverageStatus(props['电梯-电信(电梯)']),
                        '联通': formatCoverageStatus(props['电梯-联通(电梯)'])
                    })}
                </div>
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-parking"></i>
                        地下停车场覆盖
                    </div>
                    ${createPopupItems({
                        '有无地停': props['地下停车场-有无地停(地下停车场)'] || '暂无',
                        '移动': formatCoverageStatus(props['地下停车场-移动(地下停车场)']),
                        '电信': formatCoverageStatus(props['地下停车场-电信(地下停车场)']),
                        '联通': formatCoverageStatus(props['地下停车场-联通(地下停车场)'])
                    })}
                </div>
            `;
            
            // 业主信息内容
            const businessContent = document.createElement('div');
            businessContent.id = 'business-content';
            businessContent.style.display = 'none';
            businessContent.innerHTML = `
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-user-tie"></i>
                        业主信息
                    </div>
                    ${createPopupItems({
                        '业主单位': props['业主信息-业主/管理单位名称'] || '暂无',
                        '接口人姓名': props['业主信息-接口人姓名'] || '暂无',
                        '联系电话': props['业主信息-接口人联系电话'] || '暂无'
                    })}
                </div>
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-user-shield"></i>
                        负责人信息
                    </div>
                    ${createPopupItems({
                        '区域经理': props['区域负责人信息-区域经理姓名'] || '暂无',
                        '区域经理电话': props['区域负责人信息-区域经理手机号'] || '暂无',
                        '地市负责人': props['地市负责人信息-姓名(地市)'] || '暂无',
                        '省负责人': props['省负责人信息-姓名(省)'] || '暂无'
                    })}
                </div>
            `;
            
            // 网络质量内容
            const networkContent = document.createElement('div');
            networkContent.id = 'network-content';
            networkContent.style.display = 'none';
            
            const networkData = {};
            ['mobile', 'unicom', 'telecom'].forEach(operator => {
                ['4g', '5g'].forEach(network => {
                    const avgRsrpKey = `${operator}_${network}_avg_rsrp`;
                    const weakPercentKey = `${operator}_${network}_weak_percent`;
                    if (props[avgRsrpKey]) {
                        const label = `${operator === 'mobile' ? '移动' : operator === 'unicom' ? '联通' : '电信'} ${network.toUpperCase()}`;
                        networkData[`${label} 平均RSRP`] = `${parseFloat(props[avgRsrpKey]).toFixed(2)} dBm`;
                        networkData[`${label} 弱覆盖率`] = `${parseFloat(props[weakPercentKey] || 0).toFixed(2)}%`;
                    }
                });
            });
            
            networkContent.innerHTML = `
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-signal"></i>
                        网络质量指标
                    </div>
                    ${createPopupItems(networkData)}
                </div>
            `;
            
            content.appendChild(tabs);
            content.appendChild(basicContent);
            content.appendChild(coverageContent);
            content.appendChild(businessContent);
            content.appendChild(networkContent);
            
            popupDiv.appendChild(header);
            popupDiv.appendChild(content);
            
            return popupDiv;
        }

        // 格式化覆盖状态
        function formatCoverageStatus(status) {
            if (!status || status === null) return '<span class="special-value warning">暂无数据</span>';
            if (status === '覆盖良好') return '<span class="special-value good">覆盖良好</span>';
            if (status === '覆盖一般') return '<span class="special-value warning">覆盖一般</span>';
            if (status === '覆盖较差' || status === '无覆盖') return '<span class="special-value danger">' + status + '</span>';
            return status;
        }

        // 创建弹窗项目
        function createPopupItems(data) {
            let html = '';
            Object.entries(data).forEach(([key, value]) => {
                if (value && value !== '暂无' && value !== null) {
                    // 检查是否是特殊值需要高亮
                    let displayValue = value;
                    if (typeof value === 'string' && value.includes('dBm')) {
                        const rsrpValue = parseFloat(value);
                        if (rsrpValue > -80) {
                            displayValue = `<span class="popup-value highlight">${value}</span>`;
                        }
                    }
                    
                    html += `
                        <div class="popup-item">
                            <span class="popup-label">${key}:</span>
                            <span class="popup-value">${displayValue}</span>
                        </div>
                    `;
                }
            });
            return html;
        }

        // 切换标签页
        function switchTab(tab, contentId) {
            // 切换标签激活状态
            const tabs = tab.parentElement.querySelectorAll('.popup-tab');
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // 切换内容显示
            const contents = tab.parentElement.parentElement.querySelectorAll('[id$="-content"]');
            contents.forEach(c => c.style.display = 'none');
            document.getElementById(`${contentId}-content`).style.display = 'block';
        }

        // 创建建筑物弹窗内容
        function createBuildingPopup(props) {
            const popupDiv = document.createElement('div');
            
            // 创建弹窗头部
            const header = document.createElement('div');
            header.className = 'popup-header';
            header.innerHTML = `
                <span>${props.name || '建筑物信息'}</span>
                <button class="popup-close-btn" onclick="map.closePopup()">×</button>
            `;
            
            // 创建弹窗内容
            const content = document.createElement('div');
            content.className = 'popup-content';
            
            // 基本信息
            const basicSection = document.createElement('div');
            basicSection.className = 'popup-section';
            basicSection.innerHTML = `
                <div class="popup-section-title">
                    <i class="fas fa-building"></i>
                    基本信息
                </div>
                ${createPopupItems({
                    '建筑物名称': props.name,
                    '数据点数': props.point_count || props.total_points || 0,
                    '平均RSRP': props.avg_rsrp ? props.avg_rsrp.toFixed(2) + ' dBm' : 'N/A',
                    '弱覆盖占比': props.weak_percent ? props.weak_percent.toFixed(2) + '%' : 'N/A'
                })}
            `;
            
            // 运营商统计
            const operatorSection = document.createElement('div');
            operatorSection.className = 'popup-section';
            
            const operatorData = {};
            const operators = ['mobile', 'unicom', 'telecom'];
            const operatorNames = {
                'mobile': '中国移动',
                'unicom': '中国联通',
                'telecom': '中国电信'
            };
            
            operators.forEach(operator => {
                ['4g', '5g'].forEach(network => {
                    const prefix = `${operator}_${network}`;
                    if (props[`${prefix}_total`] && props[`${prefix}_total`] > 0) {
                        const label = `${operatorNames[operator]} ${network.toUpperCase()}`;
                        operatorData[`${label} 数据点`] = props[`${prefix}_total`];
                        operatorData[`${label} 平均RSRP`] = props[`${prefix}_avg_rsrp`] ? 
                            props[`${prefix}_avg_rsrp`].toFixed(2) + ' dBm' : 'N/A';
                        operatorData[`${label} 弱覆盖率`] = props[`${prefix}_weak_percent`] ? 
                            props[`${prefix}_weak_percent`].toFixed(2) + '%' : 'N/A';
                    }
                });
            });
            
            operatorSection.innerHTML = `
                <div class="popup-section-title">
                    <i class="fas fa-chart-bar"></i>
                    运营商统计
                </div>
                ${createPopupItems(operatorData)}
            `;
            
            content.appendChild(basicSection);
            content.appendChild(operatorSection);
            
            popupDiv.appendChild(header);
            popupDiv.appendChild(content);
            
            return popupDiv;
        }

        // 创建栅格弹窗内容 - 完整显示信息
        function createGridPopup(props, operator, network) {
            const operatorNames = {
                'mobile': '中国移动',
                'unicom': '中国联通',
                'telecom': '中国电信'
            };

            const popupDiv = document.createElement('div');
            
            // 创建弹窗头部
            const header = document.createElement('div');
            header.className = 'popup-header';
            header.innerHTML = `
                <span>${operatorNames[operator]} ${network.toUpperCase()} 栅格信息</span>
                <button class="popup-close-btn" onclick="map.closePopup()">×</button>
            `;
            
            // 创建弹窗内容
            const content = document.createElement('div');
            content.className = 'popup-content';
            
            // 获取信号等级
            const signalLevel = getSignalLevel(props.rsrp, network);
            let levelClass = 'warning';
            if (signalLevel === '优秀') levelClass = 'good';
            else if (signalLevel === '差') levelClass = 'danger';
            
            const gridData = {
                'RSRP值': props.rsrp ? props.rsrp.toFixed(2) + ' dBm' : 'N/A',
                '数据点数': props.count || 0,
                '网络类型': props.network_type || network.toUpperCase(),
                '信号等级': `<span class="special-value ${levelClass}">${signalLevel}</span>`
            };
            
            content.innerHTML = `
                <div class="popup-section">
                    <div class="popup-section-title">
                        <i class="fas fa-signal"></i>
                        信号质量
                    </div>
                    ${createPopupItems(gridData)}
                </div>
            `;
            
            popupDiv.appendChild(header);
            popupDiv.appendChild(content);
            
            return popupDiv;
        }

        // 获取信号等级
        function getSignalLevel(rsrp, network) {
            if (!rsrp) return '未知';
            
            if (network === '4g') {
                if (rsrp > -80) return '优秀';
                else if (rsrp > -100) return '良好';
                else if (rsrp > -115) return '一般';
                else return '差';
            } else { // 5G
                if (rsrp > -75) return '优秀';
                else if (rsrp > -95) return '良好';
                else if (rsrp > -110) return '一般';
                else return '差';
            }
        }

        // 加载运营商网络数据
        function loadOperatorNetworkData(operator, network) {
            const filename = `grid_${operator}_${network}.geojson`;
            return loadGeoJson(filename, function(feature) {
                return {
                    fillColor: feature.properties.color,
                    weight: 1,
                    opacity: 1,
                    color: 'rgba(255, 255, 255, 0.3)',
                    fillOpacity: 0.7
                };
            }, function(feature, layer) {
                const popupContent = createGridPopup(feature.properties, operator, network);
                layer.bindPopup(popupContent, {
                    className: 'custom-popup'
                });
            }, layerGroups.grids[operator][network]);
        }

        // 加载建筑物数据
        function loadBuildingData(operator, network) {
            const filename = `buildings_${operator}_${network}.geojson`;
            return loadGeoJson(filename, function(feature) {
                return {
                    fillColor: feature.properties.color || '#00ffff',
                    weight: 2,
                    opacity: 1,
                    color: '#fff',
                    fillOpacity: 0.8
                };
            }, function(feature, layer) {
                const popupContent = createBuildingPopup(feature.properties);
                layer.bindPopup(popupContent, {
                    className: 'custom-popup',
                    maxWidth: 600,
                    minWidth: 400
                });
            }, layerGroups.buildings[operator][network]);
        }

        // 加载场景数据
        function loadSceneData(sceneType) {
            const filename = `aoi_${sceneType}.geojson`;
            return loadGeoJson(filename, {
                color: '#ff6b35',
                weight: 2,
                fillColor: '#ff6b35',
                fillOpacity: 0.2
            }, function(feature, layer) {
                const popupDiv = document.createElement('div');
                
                const header = document.createElement('div');
                header.className = 'popup-header';
                header.innerHTML = `
                    <span>场景: ${sceneType}</span>
                    <button class="popup-close-btn" onclick="map.closePopup()">×</button>
                `;
                
                const content = document.createElement('div');
                content.className = 'popup-content';
                content.innerHTML = `
                    <div class="popup-section">
                        <div class="popup-section-title">
                            <i class="fas fa-map-marked-alt"></i>
                            场景信息
                        </div>
                        ${createPopupItems({
                            '场景类型': sceneType,
                            'AOI名称': feature.properties.name || '未知'
                        })}
                    </div>
                `;
                
                popupDiv.appendChild(header);
                popupDiv.appendChild(content);
                
                layer.bindPopup(popupDiv, {
                    className: 'custom-popup'
                });
            }, layerGroups.scenes[sceneType]);
        }

        // 加载测试数据
        function loadTestData(dataType) {
            let filename;
            switch(dataType) {
                case 'step-measurement':
                    filename = 'stepmeasurement.geojson';
                    break;
                case 'point-measurement':
                    filename = 'pointmeasurement.geojson';
                    break;
                case '3d-simulation':
                    filename = '3dsimulation.geojson';
                    break;
                case 'indoor-property':
                    filename = 'indoorproperty.geojson';
                    break;
                default:
                    return Promise.resolve(false);
            }

            return loadGeoJson(filename, {
                color: '#00ff00',
                weight: 2,
                fillOpacity: 0.5
            }, function(feature, layer) {
                const popupDiv = document.createElement('div');
                
                const header = document.createElement('div');
                header.className = 'popup-header';
                header.innerHTML = `
                    <span>测试数据: ${dataType}</span>
                    <button class="popup-close-btn" onclick="map.closePopup()">×</button>
                `;
                
                popupDiv.appendChild(header);
                
                layer.bindPopup(popupDiv, {
                    className: 'custom-popup'
                });
            }, layerGroups.testData[dataType.replace('-', '')]);
        }

        // 加载热力图数据
        function loadHeatmapData(type) {
            const filename = `${type}.geojson`;
            const isDownload = type.includes('download');
            
            return fetch(getCurrentTimePath() + filename)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 使用L.geoJSON创建栅格层
                    const geoJsonLayer = L.geoJSON(data, {
                        style: function(feature) {
                            return {
                                fillColor: feature.properties.color,
                                weight: 0.5,
                                opacity: 0.8,
                                color: '#fff',
                                fillOpacity: 0.6
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const value = feature.properties.value || 0;
                            const unit = isDownload ? 'Mbps' : 'Mbps';
                            
                            const popupDiv = document.createElement('div');
                            
                            const header = document.createElement('div');
                            header.className = 'popup-header';
                            header.innerHTML = `
                                <span>${isDownload ? '下载' : '上传'}速率</span>
                                <button class="popup-close-btn" onclick="map.closePopup()">×</button>
                            `;
                            
                            const content = document.createElement('div');
                            content.className = 'popup-content';
                            content.innerHTML = `
                                <div class="popup-section">
                                    <div class="popup-section-title">
                                        <i class="fas fa-tachometer-alt"></i>
                                        速率信息
                                    </div>
                                    ${createPopupItems({
                                        '速率': isNaN(value) ? 'N/A' : `${value.toFixed(2)} ${unit}`,
                                        '采样点数': feature.properties.count || 0
                                    })}
                                </div>
                            `;
                            
                            popupDiv.appendChild(header);
                            popupDiv.appendChild(content);
                            
                            layer.bindPopup(popupDiv, {
                                className: 'custom-popup'
                            });
                        }
                    });
                    
                    if (isDownload) {
                        layerGroups.heatmaps.download = geoJsonLayer;
                    } else {
                        layerGroups.heatmaps.upload = geoJsonLayer;
                    }
                    
                    return true;
                })
                .catch(error => {
                    console.log(`未找到热力图文件: ${filename}`);
                    return false;
                });
        }

        // 更新图例
        function updateLegend(networkType) {
            if (currentLegend) {
                map.removeControl(currentLegend);
            }

            currentLegend = L.control({position: 'bottomright'});
            currentLegend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                
                let html = '';
                
                // RSRP图例
                if (document.getElementById('grids-layer').checked) {
                    let title, ranges;
                    if (networkType === '4g') {
                        title = '4G RSRP图例';
                        ranges = [
                            { range: '> -80 dBm', color: '#00FF00' },
                            { range: '-80 ~ -100 dBm', color: '#0000FF' },
                            { range: '-100 ~ -115 dBm', color: '#FFFF00' },
                            { range: '< -115 dBm', color: '#FF0000' }
                        ];
                    } else {
                        title = '5G RSRP图例';
                        ranges = [
                            { range: '> -75 dBm', color: '#00FF00' },
                            { range: '-75 ~ -95 dBm', color: '#0000FF' },
                            { range: '-95 ~ -110 dBm', color: '#FFFF00' },
                            { range: '< -110 dBm', color: '#FF0000' }
                        ];
                    }

                    html += `<h4>${title}</h4>`;
                    ranges.forEach(item => {
                        html += `
                            <div class="legend-item">
                                <div class="legend-color" style="background:${item.color}"></div> 
                                ${item.range}
                            </div>
                        `;
                    });
                }

                // 离散点图例
                if (document.getElementById('discrete-points').checked) {
                    html += `
                        <div class="legend-item">
                            <svg width="20" height="20" style="margin-right: 10px;">
                                <circle cx="10" cy="10" r="9" fill="rgba(255, 107, 53, 0.15)" 
                                        stroke="#FF6B35" stroke-width="2"/>
                                <text x="10" y="14" text-anchor="middle" font-family="Microsoft YaHei" 
                                      font-size="6" font-weight="bold" fill="#FFFFFF" 
                                      stroke="#FF6B35" stroke-width="0.2">室分</text>
                            </svg>
                            离散点位
                        </div>
                    `;
                }

                // 热力图图例
                if (document.getElementById('heatmap-download').checked || 
                    document.getElementById('heatmap-upload').checked) {
                    html += `
                        <h4 style="margin-top: 10px;">速率热力图</h4>
                        <div class="heatmap-legend">
                            <div class="heatmap-gradient"></div>
                        </div>
                        <div class="heatmap-labels" style="width: 150px;">
                            <span>低</span>
                            <span style="margin-left: auto;">高</span>
                        </div>
                    `;
                }

                div.innerHTML = html;
                return div;
            };
            currentLegend.addTo(map);
            currentNetworkType = networkType;
        }

        // 销毁图表实例
        function destroyCharts() {
            Object.values(chartInstances).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            chartInstances = {};
        }

        // 初始化图表
        function initCharts() {
            destroyCharts();
            
            // 设置图表默认样式
            Chart.defaults.color = '#fff';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            Chart.defaults.font.family = "'Microsoft YaHei', 'Exo 2', sans-serif";

            if (!statisticsData) {
                createEmptyCharts();
                return;
            }

            // 市场份额图表
            const marketCtx = document.getElementById('market-share-chart').getContext('2d');
            const marketData = [];
            const marketLabels = [];
            
            Object.entries(statisticsData.operators).forEach(([operator, data]) => {
                const total = data['4g'].total + data['5g'].total;
                if (total > 0) {
                    marketLabels.push(operator === 'mobile' ? '中国移动' : 
                                     operator === 'unicom' ? '中国联通' : '中国电信');
                    marketData.push(total);
                }
            });

            chartInstances.marketChart = new Chart(marketCtx, {
                type: 'doughnut',
                data: {
                    labels: marketLabels,
                    datasets: [{
                        data: marketData,
                        backgroundColor: [
                            'rgba(0, 255, 255, 0.8)',
                            'rgba(255, 0, 255, 0.8)',
                            'rgba(255, 255, 0, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });

            // 终端品牌图表
            const brandCtx = document.getElementById('brand-chart').getContext('2d');
            const brandData = Object.entries(statisticsData.terminal_brands || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            chartInstances.brandChart = new Chart(brandCtx, {
                type: 'bar',
                data: {
                    labels: brandData.map(item => item[0]),
                    datasets: [{
                        label: '使用量',
                        data: brandData.map(item => item[1]),
                        backgroundColor: 'rgba(0, 255, 255, 0.6)',
                        borderColor: '#00ffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // 场景覆盖分析图表
            const sceneCtx = document.getElementById('scene-coverage-chart').getContext('2d');
            const sceneLabels = [];
            const scene4gData = [];
            const scene5gData = [];
            const sceneNames = {
                'education': '高等学校',
                'transport': '交通枢纽',
                'business': '商务楼宇',
                'tourism': '文旅场景',
                'medical': '医疗机构',
                'government': '政务中心',
                'shopping': '重点商超',
                'residential': '住宅小区'
            };

            Object.entries(statisticsData.scenes).forEach(([scene, data]) => {
                if (data.count > 0) {
                    sceneLabels.push(sceneNames[scene] || scene);
                    scene4gData.push(data.weak_coverage_4g || 0);
                    scene5gData.push(data.weak_coverage_5g || 0);
                }
            });

            chartInstances.sceneChart = new Chart(sceneCtx, {
                type: 'radar',
                data: {
                    labels: sceneLabels,
                    datasets: [
                        {
                            label: '4G弱覆盖率',
                            data: scene4gData,
                            borderColor: 'rgba(0, 255, 255, 0.8)',
                            backgroundColor: 'rgba(0, 255, 255, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: '#00ffff',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#00ffff'
                        },
                        {
                            label: '5G弱覆盖率',
                            data: scene5gData,
                            borderColor: 'rgba(255, 0, 255, 0.8)',
                            backgroundColor: 'rgba(255, 0, 255, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: '#ff00ff',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#ff00ff'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#fff',
                                font: {
                                    size: 11
                                }
                            },
                            ticks: {
                                color: '#fff',
                                backdropColor: 'transparent'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // 创建空图表
        function createEmptyCharts() {
            const contexts = [
                'market-share-chart',
                'brand-chart',
                'scene-coverage-chart'
            ];

            contexts.forEach(contextId => {
                const ctx = document.getElementById(contextId).getContext('2d');
                chartInstances[contextId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['暂无数据'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#666666'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            });
        }

        // 数据更新动画
        function animateDataUpdate() {
            document.querySelectorAll('.number-value, .stat-value, .bottom-stat-value').forEach(el => {
                el.classList.add('data-update');
                setTimeout(() => el.classList.remove('data-update'), 500);
            });
        }

        // 事件处理
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            document.getElementById('year-selector').value = currentYear;
            document.getElementById('month-selector').value = currentMonth;
            updateCurrentTimeDisplay();
            
            loadStatistics();
            loadBaseData();
            updateLegend('4g');

            // 时间选择器事件监听
            document.getElementById('year-selector').addEventListener('change', function(e) {
                currentYear = e.target.value;
                handleTimeChange();
            });

            document.getElementById('month-selector').addEventListener('change', function(e) {
                currentMonth = e.target.value;
                handleTimeChange();
            });

            // 功能按钮事件
            document.querySelectorAll('.feature-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const layerType = this.dataset.layer;
                    this.classList.toggle('active');
                    
                    if (this.classList.contains('active')) {
                        loadTestData(layerType).then(success => {
                            if (success) {
                                const layerKey = layerType.replace('-', '');
                                if (layerGroups.testData[layerKey]) {
                                    layerGroups.testData[layerKey].addTo(map);
                                }
                            }
                        });
                    } else {
                        const layerKey = layerType.replace('-', '');
                        if (layerGroups.testData[layerKey]) {
                            map.removeLayer(layerGroups.testData[layerKey]);
                            layerGroups.testData[layerKey].clearLayers();
                        }
                    }
                });
            });

            // AOI控制
            document.getElementById('aoi-border').addEventListener('change', function(e) {
                updateAoiLayer();
            });

            // 离散点控制
            document.getElementById('discrete-points').addEventListener('change', function(e) {
                if (e.target.checked) {
                    map.addLayer(layerGroups.discretePoints);
                } else {
                    map.removeLayer(layerGroups.discretePoints);
                }
                updateLegend(currentNetworkType);
            });

            // 建筑物图层控制
            document.getElementById('buildings-layer').addEventListener('change', function(e) {
                updateBuildingsLayer();
            });

            // 栅格图层控制
            document.getElementById('grids-layer').addEventListener('change', function(e) {
                updateGridsLayer();
            });

            // 场景控制
            const sceneMapping = {
                'scene-education': 'education',
                'scene-transport': 'transport',
                'scene-business': 'business',
                'scene-tourism': 'tourism',
                'scene-medical': 'medical',
                'scene-government': 'government',
                'scene-shopping': 'shopping',
                'scene-residential': 'residential'
            };

            Object.entries(sceneMapping).forEach(([checkboxId, sceneType]) => {
                document.getElementById(checkboxId).addEventListener('change', function(e) {
                    updateAoiLayer();
                    updateGridsLayer();
                    updateHeatmapLayers();
                    
                    if (e.target.checked) {
                        layerGroups.scenes[sceneType].addTo(map);
                    } else {
                        map.removeLayer(layerGroups.scenes[sceneType]);
                        layerGroups.scenes[sceneType].clearLayers();
                    }
                });
            });

            // 运营商网络控制
            const operators = ['mobile', 'unicom', 'telecom'];
            const networks = ['4g', '5g'];

            // 运营商主复选框控制
            operators.forEach(operator => {
                const mainCheckbox = document.getElementById(`operator-${operator}`);
                const subLayersDiv = document.getElementById(`${operator}-sub-layers`);
                
                mainCheckbox.addEventListener('change', function(e) {
                    // 显示/隐藏子层
                    subLayersDiv.style.display = e.target.checked ? 'flex' : 'none';
                    
                    // 联动控制子网络复选框
                    networks.forEach(network => {
                        const subCheckbox = document.getElementById(`${operator}-${network}`);
                        if (subCheckbox) {
                            subCheckbox.checked = e.target.checked;
                            // 触发子复选框的change事件
                            subCheckbox.dispatchEvent(new Event('change'));
                        }
                    });
                });
            });

            // 网络类型复选框控制
            operators.forEach(operator => {
                networks.forEach(network => {
                    const checkboxId = `${operator}-${network}`;
                    document.getElementById(checkboxId).addEventListener('change', function(e) {
                        // 更新图层
                        updateBuildingsLayer();
                        updateGridsLayer();
                        
                        // 更新父复选框状态
                        const parentCheckbox = document.getElementById(`operator-${operator}`);
                        const network4gChecked = document.getElementById(`${operator}-4g`).checked;
                        const network5gChecked = document.getElementById(`${operator}-5g`).checked;
                        
                        if (network4gChecked || network5gChecked) {
                            parentCheckbox.checked = true;
                            document.getElementById(`${operator}-sub-layers`).style.display = 'flex';
                        } else {
                            parentCheckbox.checked = false;
                            document.getElementById(`${operator}-sub-layers`).style.display = 'none';
                        }
                        
                        currentOperator = operator;
                        currentNetworkType = network;
                    });
                });
            });

            // 热力图控制
            document.getElementById('heatmap-download').addEventListener('change', function(e) {
                updateHeatmapLayers();
                updateLegend(currentNetworkType);
            });

            document.getElementById('heatmap-upload').addEventListener('change', function(e) {
                updateHeatmapLayers();
                updateLegend(currentNetworkType);
            });
        });
    </script>
</body>
</html>